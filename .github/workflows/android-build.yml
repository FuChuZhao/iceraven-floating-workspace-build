name: Public Build Dispatcher

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Private source repository via SSH (owner/repo)'
        required: true
        type: string
      source_ref:
        description: 'Source repo ref/commit to build'
        required: true
        type: string
      artifact_name:
        description: 'Artifact name to upload'
        required: true
        type: string
      artifact_path:
        description: 'Relative path to artifact directory in source repo'
        required: true
        default: build/artifacts
        type: string
      run_ui_tests:
        description: 'Run emulator UI click/screenshot verification'
        required: true
        default: true
        type: boolean
      ui_artifact_name:
        description: 'Artifact name for UI test screenshots/logs'
        required: true
        default: floating-workspace-ui-evidence
        type: string

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare SSH key for private source clone
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SOURCE_REPO_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private source repository
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 "git@github.com:${{ inputs.source_repo }}.git" .
          git fetch --depth 1 origin "${{ inputs.source_ref }}"
          git checkout FETCH_HEAD

      - name: Run source-controlled build entrypoint
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -x tools/ci/build.sh ]]; then
            echo "tools/ci/build.sh not found or not executable" >&2
            exit 1
          fi
          ./tools/ci/build.sh

      - name: Run emulator UI verification
        if: ${{ inputs.run_ui_tests }}
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_6
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: >-
            bash -lc 'set -euo pipefail; APK_PATH="$(find build/artifacts -maxdepth 1 -type f -name "*x86_64*-qa-signed.apk" | head -n 1 || true)"; if [[ -z "${APK_PATH}" ]]; then echo "x86_64 qa-signed apk not found under build/artifacts" >&2; find build/artifacts -maxdepth 2 -type f -print || true; exit 1; fi; python3 -m http.server 8787 --bind 127.0.0.1 >/tmp/floating_workspace_site.log 2>&1 & SITE_PID=$!; cleanup() { kill "${SITE_PID}" >/dev/null 2>&1 || true; }; trap cleanup EXIT; export TEST_URL="http://10.0.2.2:8787/tools/qa/site/index.html"; adb install -r "${APK_PATH}"; if ! timeout 20m bash -lc "OUT_DIR=artifacts/floating-workspace/cloud-emulator VISUAL_CAPTURE_SCENARIO=core SETTLE_TIME_SECONDS=2 ACTION_PAUSE_SECONDS=1 ADB_SCREENSHOT_TIMEOUT_SECONDS=25 ADB_SCREENSHOT_RETRIES=2 ADB_UI_DUMP_TIMEOUT_SECONDS=2 ANR_RECOVERY_RETRY_COUNT=2 ANR_RECOVERY_SETTLE_SECONDS=1 ANR_TEXT_TAP_ENABLED=false ANR_EVIDENCE_CAPTURE=false STATE_DUMP_INCLUDE_UI=false ./tools/qa/floating_workspace_visual_capture.sh"; then echo "[WARN] floating workspace visual capture failed or timed out"; fi; if ! timeout 6m bash -lc "ENABLE_DEBUG_SCREENSHOTS=false DEBUG_OUT_DIR=artifacts/floating-workspace/cloud-emulator/click-debug SETTLE_TIME_SECONDS=2 ACTION_PAUSE_SECONDS=1 ADB_SCREENSHOT_TIMEOUT_SECONDS=12 ADB_SCREENSHOT_RETRIES=1 ADB_UI_DUMP_TIMEOUT_SECONDS=2 ANR_RECOVERY_RETRY_COUNT=2 ANR_RECOVERY_SETTLE_SECONDS=1 ANR_TEXT_TAP_ENABLED=false ANR_EVIDENCE_CAPTURE=false STATE_DUMP_INCLUDE_UI=false ./tools/qa/floating_workspace_click_test.sh"; then echo "[WARN] floating workspace click test failed or timed out"; fi'

      - name: Inspect UI verification artifacts
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d artifacts/floating-workspace ]]; then
            echo "artifacts/floating-workspace does not exist"
            exit 0
          fi
          echo "UI evidence files:"
          find artifacts/floating-workspace -maxdepth 8 -type f | sort

      - name: Upload UI verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.ui_artifact_name }}
          path: artifacts/floating-workspace
          if-no-files-found: warn
          retention-days: 1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.artifact_path }}
          if-no-files-found: error
          retention-days: 1
