name: Public Build Dispatcher

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Private source repository via SSH (owner/repo)'
        required: true
        type: string
      source_ref:
        description: 'Source repo ref/commit to build'
        required: true
        type: string
      artifact_name:
        description: 'Artifact name to upload'
        required: true
        type: string
      artifact_path:
        description: 'Relative path to artifact directory in source repo'
        required: true
        default: build/artifacts
        type: string
      run_ui_tests:
        description: 'Run emulator UI click/screenshot verification'
        required: true
        default: true
        type: boolean
      ui_artifact_name:
        description: 'Artifact name for UI test screenshots/logs'
        required: true
        default: floating-workspace-ui-evidence
        type: string

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare SSH key for private source clone
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SOURCE_REPO_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private source repository
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 "git@github.com:${{ inputs.source_repo }}.git" .
          git fetch --depth 1 origin "${{ inputs.source_ref }}"
          git checkout FETCH_HEAD

      - name: Run source-controlled build entrypoint
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -x tools/ci/build.sh ]]; then
            echo "tools/ci/build.sh not found or not executable" >&2
            exit 1
          fi
          ./tools/ci/build.sh

      - name: Run emulator UI verification
        if: ${{ inputs.run_ui_tests }}
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_6
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: >-
            bash -lc 'set -euo pipefail; APK_PATH="$(find build/artifacts -maxdepth 1 -type f -name "*x86_64*-qa-signed.apk" | head -n 1 || true)"; if [[ -z "${APK_PATH}" ]]; then echo "x86_64 qa-signed apk not found under build/artifacts" >&2; find build/artifacts -maxdepth 2 -type f -print || true; exit 1; fi; adb install -r "${APK_PATH}"; export UI_DUMP_RETRIES=1; DEBUG_OUT_DIR="artifacts/floating-workspace/cloud-emulator/click-debug" ./tools/qa/floating_workspace_click_test.sh; OUT_DIR="artifacts/floating-workspace/cloud-emulator" ./tools/qa/floating_workspace_visual_capture.sh'

      - name: Inspect UI verification artifacts
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d artifacts/floating-workspace ]]; then
            echo "artifacts/floating-workspace does not exist"
            exit 0
          fi
          echo "UI evidence files:"
          find artifacts/floating-workspace -maxdepth 8 -type f | sort

      - name: Upload UI verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.ui_artifact_name }}
          path: artifacts/floating-workspace
          if-no-files-found: warn
          retention-days: 1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.artifact_path }}
          if-no-files-found: error
          retention-days: 1
